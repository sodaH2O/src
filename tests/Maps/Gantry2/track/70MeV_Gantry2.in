/*OPTION, VERSION=10900;

OPTION, ECHO=FALSE; 
OPTION, PSDUMPFREQ=3500;


OPTION, TELL=TRUE;
OPTION, MEMORYDUMP=TRUE;*/


OPTION, ECHO=FALSE;
OPTION, INFO=TRUE;
OPTION, VERSION=10900;
OPTION, STATDUMPFREQ=10;
OPTION, PSDUMPFREQ=1000;

//------------------------- collimator sizes
REAL Coll_b4gap_size=0.0180;
//Coll_atgap_size=0.0060;
REAL Coll_aftrgap_size=0.0140;

REAL Coll_atgap_size = 0.005;


REAL NProt = 1000;

// OPAL Input forLA2line

REAL TFast = 1e-11;
REAL TSlow = 1e-12;
REAL TNozzSlow = 1e-12;

REAL TDeg = 1e-12;
REAL Edes = 0.07381;
REAL gamma = (Edes+PMASS)/PMASS;
REAL beta = sqrt(1-(1/gamma^2));
REAL gambet = gamma*beta;
REAL P0 = gamma*beta*PMASS;
REAL brho = (PMASS*1.0e9*gambet) / CLIGHT;

VALUE,{gamma,brho,Edes,beta,gambet};
//AMF1: SBEND, K0=0.804307, L=1.4929, ELEMEDGE=39.0362,
REAL rf = 50.6328e6;
//NProt = 60000;


REAL fact_x  =1.400;
REAL fact_xd =1.40;
REAL fact_y  =1.400;
REAL fact_yd =1.40;
REAL fact_delp=2.30;


//--------------------------------------------------------------------------------
//Input beam parameters    AT STEP 474, SPOS 31.5926
//--------------------------------------------------------------------------------
DISTRIB1: DISTRIBUTION, 
	TYPE=GAUSS,
//Energy MeV =  73.6503
	SIGMAX = 0.00253256*fact_x,     SIGMAPX = 0.00231138*gambet*fact_xd  ,
	SIGMAY = 0.00938593*fact_y,     SIGMAPY = 0.00161825*gambet*fact_yd ,
	SIGMAZ = 0.00970918*0.000001,      SIGMAPZ = 0.00171298*gambet*fact_delp  ,
	CORRX =  0.858145,       CORRY =  0.967638,      CORRZ =  0.999981,
	R51 =  -0.00957565,      R52 =  0.103166,        R61 =  -0.0074746,      R62 =  0.105198,

	CUTOFFX = 5, CUTOFFPX = 5, CUTOFFY = 5,
	CUTOFFPY = 5, CUTOFFLONG = 5, CUTOFFPZ = 5,
	OFFSETX = 0, OFFSETY =0, OFFSETZ = 0,
	INPUTMOUNITS = NONE;


//--------------------------------------------------------------------------------
// Beamline elements
//--------------------------------------------------------------------------------
D67: DRIFT, L=0.9, ELEMEDGE=31.532;
//MMBHL02: ECOLLIMATOR, XSIZE=0.0409, YSIZE=0.0409, L=0.004, ELEMEDGE=32.432;
D69: DRIFT, L=0.196, ELEMEDGE=32.436;
QMB3: QUADRUPOLE, K1=-3.67009, L=0.368, ELEMEDGE=32.632;
//QMB3_r0: ECOLLIMATOR, XSIZE=0.0465, YSIZE=0.0465, L=0.368, ELEMEDGE=32.632;
D70: DRIFT, L=0.202, ELEMEDGE=33;
QMB4: QUADRUPOLE, K1=6.26124, L=0.368, ELEMEDGE=33.202;
//QMB4_r0: ECOLLIMATOR, XSIZE=0.0465, YSIZE=0.0465, L=0.368, ELEMEDGE=33.202;
D71: DRIFT, L=0.202, ELEMEDGE=33.57;
QMB5: QUADRUPOLE, K1=-3.333, L=0.368, ELEMEDGE=33.772;
//QMB5_r0: ECOLLIMATOR, XSIZE=0.0465, YSIZE=0.0465, L=0.368, ELEMEDGE=33.772;
D71A: DRIFT, L=0.3175, ELEMEDGE=34.14;
MMBP7X: MONITOR, OUTFN="MMBP7X.h5", ELEMEDGE=34.4575;
MMBP8Y: MONITOR, OUTFN="MMBP8Y.h5", ELEMEDGE=34.4575;

D72: DRIFT, L=0.04250, ELEMEDGE=34.4575; //D72: DRIFT, L=0.1687, ELEMEDGE=34.4575;

//CollPHYS_Cu :  SURFACEPHYSICS, TYPE="Collimator", MATERIAL="Copper";


//Coll_b4gap_size=0.0550; //default=0.0550
//Coll_b4gap: ECOLLIMATOR, XSIZE=Coll_b4gap_size, YSIZE=Coll_b4gap_size, DX=0,  DY=0,
//L=0.050, ELEMEDGE=34.50, OUTFN="Coll_b4Gap_size.h5";// , SURFACEPHYSICS=CollPHYS_Cu ;
Mon_Coll_b4gap: MONITOR, OUTFN="Mon_Coll_beforeGap.h5", ELEMEDGE=34.50+0.050;		//here

//

SMB3: DRIFT, L=0.45380, ELEMEDGE=34.5600;  //SMB3: DRIFT, L=0.3876, ELEMEDGE=34.6262;	//here

D73: DRIFT, L=1.0442, ELEMEDGE=35.0138;
//KMB1: ECOLLIMATOR, XSIZE=0.015, YSIZE=0.015, L=0.075, ELEMEDGE=36.058;
D74A: DRIFT, L=0.044, ELEMEDGE=36.133;
Myl3: DRIFT, L=0.000122, ELEMEDGE=36.177;
D74B: DRIFT, L=0.02, ELEMEDGE=36.1771;
MMBP9X: MONITOR, OUTFN="MMBP9X.h5", ELEMEDGE=36.1971;
MMBP10Y: MONITOR, OUTFN="MMBP10Y.h5", ELEMEDGE=36.1971;

//


//Coll_atgap_size=0.0150;  //default=0.0150
//Coll_atgap: ECOLLIMATOR, XSIZE=Coll_atgap_size, YSIZE=Coll_atgap_size, DX=0,  DY=0,
//L=0.050, ELEMEDGE=36.2071, OUTFN="Coll_atGap.h5";//, SURFACEPHYSICS=CollPHYS_Cu ;
Mon_Coll_atgap: MONITOR, OUTFN="Mon_Coll_atGap.h5", ELEMEDGE=36.2071+0.050+0.010;

//




//D74: DRIFT, L=0.003, ELEMEDGE=36.2571;
//D75: DRIFT, L=0.005, ELEMEDGE=36.26010;
//KMB2i: ECOLLIMATOR, XSIZE=0.004, YSIZE=0.004, L=0.004, ELEMEDGE=36.2551;			//here
UPG2A: DRIFT, L=0.02550, ELEMEDGE=36.26710;	//UPG2A: DRIFT, L=0.0335, ELEMEDGE=36.2591;	//here

UPG2X: MONITOR, OUTFN="UPG2X.h5", ELEMEDGE=36.2926;
UPG2Y: MONITOR, OUTFN="UPG2Y.h5", ELEMEDGE=36.2926;
UPG2B: DRIFT, L=0.0335, ELEMEDGE=36.2926;
//KMB2o: ECOLLIMATOR, XSIZE=0.004, YSIZE=0.004, L=0.004, ELEMEDGE=36.3261;
D76: DRIFT, L=0.015, ELEMEDGE=36.3301;
Titan: DRIFT, L=3e-05, ELEMEDGE=36.3451;
D77: DRIFT, L=0.064, ELEMEDGE=36.3451;
D78: DRIFT, L=0.0925, ELEMEDGE=36.4091;

Deg: DRIFT, L=0.40, ELEMEDGE=36.5016;
Myl4: DRIFT, L=0.0001, ELEMEDGE=36.9016;
D79: DRIFT, L=0.1455, ELEMEDGE=36.9017;
D80: DRIFT, L=0.3245, ELEMEDGE=37.0472;
MMFP1X: MONITOR, OUTFN="MMFP1X.h5", ELEMEDGE=37.3717;
MMFP2Y: MONITOR, OUTFN="MMFP2Y.h5", ELEMEDGE=37.3717;

D81a: DRIFT, L=0.160, ELEMEDGE=37.3717; //original length L=0.2785


//


//Coll_aftrgap_size=0.0240;     //default= 0.0240
//Coll_aftergap: ECOLLIMATOR, XSIZE=Coll_aftrgap_size, YSIZE=Coll_aftrgap_size, DX=0,  DY=0,
//L=0.050, ELEMEDGE=37.5317, OUTFN="Coll_afterGap.h5";//, SURFACEPHYSICS=CollPHYS_Cu ;
Mon_Coll_aftrgap: MONITOR, OUTFN="Mon_Coll_afterGap.h5", ELEMEDGE=37.5317+0.050+0.010;	


//
D81b: DRIFT, L=0.0585, ELEMEDGE=37.5917;						//here



QMF1: QUADRUPOLE, K1=-4.22518, L=0.32, ELEMEDGE=37.6502;
//QMF1_r0: ECOLLIMATOR, XSIZE=0.038, YSIZE=0.038, L=0.32, ELEMEDGE=37.6502;
QMFC: DRIFT, L=0.155, ELEMEDGE=37.9702;
D82: DRIFT, L=0.155, ELEMEDGE=38.1252;
QMF2: QUADRUPOLE, K1=4.73565, L=0.32, ELEMEDGE=38.2802;
//QMF2_r0: ECOLLIMATOR, XSIZE=0.038, YSIZE=0.038, L=0.32, ELEMEDGE=38.2802;
D83: DRIFT, L=0.436, ELEMEDGE=38.6002;
AMF1: SBEND, K0=0.804307, L=1.4929, ELEMEDGE=39.0362,
         //ANGLE=1.01229, HAPERT=46.5*2/1000,  K1=0,
         //E1=0.188146, E2=0.188146,
        FMAPFN="HardEdge.T7",//"1DPROFILE1-DEFAULT",
         DESIGNENERGY=7.381e+01, GAP=.2;//30*2/1000;
//AMF1_r0: ECOLLIMATOR, XSIZE=0.0465, YSIZE=0.0275, L=1.5586, ELEMEDGE=39.0362;
D84: DRIFT, L=0.395, ELEMEDGE=40.5948;
MMFP3X: MONITOR, OUTFN="MMFP3X.h5", ELEMEDGE=40.9898;
MMFP4Y: MONITOR, OUTFN="MMFP4Y.h5", ELEMEDGE=40.9898;
D86: DRIFT, L=0.2667, ELEMEDGE=40.9898;
QMF3: QUADRUPOLE, K1=-4.21226, L=0.32, ELEMEDGE=41.2565;
//QMF3_r0: ECOLLIMATOR, XSIZE=0.038, YSIZE=0.038, L=0.32, ELEMEDGE=41.2565;
SMF2: DRIFT, L=0.17, ELEMEDGE=41.5765;
D87: DRIFT, L=0.17, ELEMEDGE=41.7465;
QMF4: QUADRUPOLE, K1=5.77077, L=0.32, ELEMEDGE=41.9165;
//QMF4_r0: ECOLLIMATOR, XSIZE=0.038, YSIZE=0.038, L=0.32, ELEMEDGE=41.9165;
D88: DRIFT, L=0.425, ELEMEDGE=42.2365;

AMF2: SBEND, //ANGLE=0.988137, L= 1.555400,
		 K0=-0.804017, L=1.4929, 
		 ELEMEDGE=42.6615,
         //ANGLE=1.01229, HAPERT=46.5*2/1000,  K1=0,
         //E1=0.188146, E2=0.188146,
        FMAPFN="HardEdge.t7", //"1DPROFILE1-DEFAULT", 
        //PSI = Pi,
         DESIGNENERGY=7.381e+01, GAP=.1;//30*2/1000;
         
//AMF2_r0: ECOLLIMATOR, XSIZE=0.0465, YSIZE=0.0275, L=1.5586, ELEMEDGE=42.6615;
D89: DRIFT, L=0.395, ELEMEDGE=44.2201;
MMFP5X: MONITOR, OUTFN="MMFP5X.h5", ELEMEDGE=44.6151;
MMFP6Y: MONITOR, OUTFN="MMFP6Y.h5", ELEMEDGE=44.6151;
SMF3: DRIFT, L=0.3446, ELEMEDGE=44.6151;
D92: DRIFT, L=0.1269, ELEMEDGE=44.9597;
QMF5: QUADRUPOLE, K1=0.0590979, L=0.32, ELEMEDGE=45.0866;
//QMF5_r0: ECOLLIMATOR, XSIZE=0.038, YSIZE=0.038, L=0.32, ELEMEDGE=45.0866;
D93: DRIFT, L=0.14, ELEMEDGE=45.4066;
QMF6: QUADRUPOLE, K1=6.0462, L=0.32, ELEMEDGE=45.5466;
//QMF6_r0: ECOLLIMATOR, XSIZE=0.038, YSIZE=0.038, L=0.32, ELEMEDGE=45.5466;
D94: DRIFT, L=0.14, ELEMEDGE=45.8666;
QMF7: QUADRUPOLE, K1=-4.66959, L=0.32, ELEMEDGE=46.0066;
//QMF7_r0: ECOLLIMATOR, XSIZE=0.038, YSIZE=0.038, L=0.32, ELEMEDGE=46.0066;
D95: DRIFT, L=0.264, ELEMEDGE=46.3266;
WMFT: DRIFT, L=0.2, ELEMEDGE=46.5906;
D96: DRIFT, L=0.18, ELEMEDGE=46.7906;
WMFU: DRIFT, L=0.34, ELEMEDGE=46.9706;
D97: DRIFT, L=0.5473, ELEMEDGE=47.3106;
AMF3: SBEND, K0=-0.811531, L=2.17747, ELEMEDGE=47.8579,
         //ANGLE=1.5708, HAPERT=75*2/1000,  K1=0,
         //E1=0.207694, E2=0.401426,
        FMAPFN="HardEdge.t7",
        //FMAPFN="1DPROFILE1-DEFAULT",
         DESIGNENERGY=7.381e+01, GAP=75*2/1000;
//AMF3_r0: ECOLLIMATOR, XSIZE=0.075, YSIZE=0.075, L=2.41856, ELEMEDGE=47.8579;


D98ext: DRIFT, L=0.373420, ELEMEDGE=50.2765; //extended beampipe

Mon_D98extX: MONITOR, OUTFN="Mon_D98extX.h5", ELEMEDGE=50.64992;
Mon_D98extY: MONITOR, OUTFN="Mon_D98extX.h5", ELEMEDGE=50.64992;
//===============================
//	NOZZLE
//===============================
REAL ExtendedLength   =0.2600 ; //-0.030;
REAL Mylar_thick175mm = 0.000175;
REAL Mylar_thick      = 2e-5;

REAL total_Mylaar_thick =Mylar_thick175mm + (10*2e-5); // 0.000375


// extendable part
D100a_vac: Drift, L=0.354560, ELEMEDGE=50.65242; 

Mylar_win1: Drift, L=total_Mylaar_thick, ELEMEDGE=51.006980;

REAL Len_air  = ExtendedLength + (0.427874 - 2e-4) + (0.470688 - 0.150);// Retractable part
REAL edge_air = 51.006980 + total_Mylaar_thick;

D100b_air: Drift, L=Len_air , ELEMEDGE=edge_air ; 


Drift_isoa: Drift, L=0.150, ELEMEDGE= 51.006980+Len_air+total_Mylaar_thick; 
Mon_ISO: MONITOR, ELEMEDGE= edge_air + Len_air + 0.150,  OUTFN="Mon_ISO.h5";
Drift_isob: Drift, L=0.200, ELEMEDGE=edge_air + Len_air + 0.150; 

Nozz_air: LINE=( D100a_vac, Mylar_win1, D100b_air, Drift_isoa, Mon_ISO, Drift_isob);
//---------------------------------//

//--------------------------------------------------------------------------------
// Define Beamline
//--------------------------------------------------------------------------------
BEAMLINE_G2: LINE=(
//D67,
//MMBHL02,
D69,QMB3,
//QMB3_r0,
D70,QMB4,
//QMB4_r0,
D71,QMB5,
//QMB5_r0,
D71A,MMBP7X,MMBP8Y,
D72,
//Coll_b4gap, 
//Mon_Coll_b4gap, 
SMB3,D73,
//KMB1,
D74A,Myl3,D74B,MMBP9X,MMBP10Y,
//Coll_atgap,
//Mon_Coll_atgap, 
UPG2A,UPG2X,UPG2Y,UPG2B,
//KMB2o,
D76,
//Titan,
D77,D78,Deg,
Myl4, D79,D80,MMFP1X,MMFP2Y,D81a, 
//Coll_aftergap,
//Mon_Coll_aftrgap,
D81b,QMF1,
//QMF1_r0,
QMFC,D82,QMF2,
//QMF2_r0,
D83,AMF1,
//AMF1_r0,
D84,MMFP3X,MMFP4Y,D86,QMF3,
//QMF3_r0,
SMF2,D87,
QMF4,
//QMF4_r0,
D88,AMF2, 
//AMF2_r0,
D89,MMFP5X,MMFP6Y,SMF3,D92,QMF5,
//QMF5_r0,
D93,QMF6,
//QMF6_r0,
D94,QMF7,
//QMF7_r0,
D95,WMFT,D96,
WMFU,D97,AMF3,
//AMF3_r0,
D98ext,Mon_D98extX,Mon_D98extY,
Mon_ISO);  
//, Nozz_air);   



//--------------------------------------------------------------------------------
FS1:FIELDSOLVER, FSTYPE=NONE, MX=64, MY=64, MT=64, PARFFTX=true, PARFFTY=false, PARFFTT=false, BCFFTX=open, BCFFTY=open, BCFFTT=open, BBOXINCR=1, GREENSF=STANDARD;
BEAM_G2: BEAM, PARTICLE=PROTON, PC=P0, NPART=NProt, BCURRENT=NProt*1.6e-19*rf, BFREQ=rf,  CHARGE=1;


REAL STEP02= 100./(beta*CLIGHT*TSlow);//(52.50 - 31.4000)/(beta*CLIGHT*TSlow);
SELECT, LINE=BEAMLINE_G2;
TRACK, LINE=BEAMLINE_G2, BEAM=BEAM_G2, MAXSTEPS= STEP02, DT=TNozzSlow, ZSTART=31.5926, ZSTOP=52.50;


//RUN, METHOD = "THICK", BEAM=BEAM_G2, FIELDSOLVER=FS1, DISTRIBUTION=DISTRIB1;


RUN, METHOD = "Parallel-T", BEAM=BEAM_G2, FIELDSOLVER=FS1, DISTRIBUTION=DISTRIB1;
ENDTRACK;



STOP;

